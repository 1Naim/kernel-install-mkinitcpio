#!/bin/bash
set -e

# This post install hook runs after the an initramfs has been generated by
# mkinitcpio. It computes the checksum of the generated initramfs file and
# renames the file to `initrd-${checksum}`

old_initrd="$2"

[[ "$old_initrd" =~ -fallback ]] && exit 0
[[ ! -f "$old_initrd" ]] && exit 0

if command -v sha256sum >/dev/null; then
    sha256out="$(sha256sum "$old_initrd")"
fi

[[ -n "$sha256out" ]] && new_initrd="${old_initrd}-${sha256out:0:12}"
mv "${old_initrd}" "${new_initrd}"

entry_file="/boot/loader/entries/$(echo "$old_initrd" | sed -E 's|/boot/([^/]+)/([^/]+)/.*|\1-\2.conf|')"

if [[ -r "$entry_file" ]]; then
    sed -i "s|^initrd .*|initrd     ${new_initrd/\/boot/}|" "$entry_file"
fi
